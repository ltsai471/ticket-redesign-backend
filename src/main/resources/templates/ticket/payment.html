<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Payment - Ticket Purchase</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="text-center">Complete Your Purchase</h3>
                    </div>
                    <div class="card-body">
                        <div class="ticket-info mb-4">
                            <h5>Ticket Details</h5>
                            <p id="seatInfo"></p>
                            <p>Price: <span id="price"></span></p>
                        </div>
                        
                        <form id="paymentForm" onsubmit="return handlePaymentSubmit(event)">
                            <div class="mb-3">
                                <label for="paymentMethod" class="form-label">Payment Method</label>
                                <select class="form-select" id="paymentMethod" required>
                                    <option value="">Select payment method</option>
                                    <option value="CREDIT_CARD">Credit Card</option>
                                    <option value="DEBIT_CARD">Debit Card</option>
                                    <option value="BANK_TRANSFER">Bank Transfer</option>
                                </select>
                            </div>
                            
                            <div id="creditCardFields" style="display: none;">
                                <div class="mb-3">
                                    <label for="cardNumber" class="form-label">Card Number</label>
                                    <input type="text" class="form-control" id="cardNumber" placeholder="1234 5678 9012 3456">
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="expiryDate" class="form-label">Expiry Date</label>
                                            <input type="text" class="form-control" id="expiryDate" placeholder="MM/YY">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="cvv" class="form-label">CVV</label>
                                            <input type="text" class="form-control" id="cvv" placeholder="123">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary" id="payButton">Pay Now</button>
                                <button type="button" class="btn btn-secondary" onclick="window.history.back()">Back</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const ticketId = urlParams.get('ticketId');
        const seatInfo = urlParams.get('seatInfo');
        const price = urlParams.get('price');

        // Display ticket information
        document.getElementById('seatInfo').textContent = seatInfo;
        document.getElementById('price').textContent = `$${price}`;

        // Show/hide credit card fields based on payment method
        document.getElementById('paymentMethod').addEventListener('change', function() {
            const creditCardFields = document.getElementById('creditCardFields');
            creditCardFields.style.display = this.value === 'CREDIT_CARD' ? 'block' : 'none';
        });

        async function handlePaymentSubmit(event) {
            event.preventDefault();
            
            const payButton = document.getElementById('payButton');
            payButton.disabled = true;
            payButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing Payment...';

            try {
                // Call the payTicket endpoint
                const response = await fetch(`/oper/payTicket?id=${ticketId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    if (data.status === 'SUCCESS') {
                        window.location.href = `/ticket/success?ticketId=${ticketId}`;
                    } else if (data.status === 'FAILED') {
                        alert(data.message || 'Payment failed. Please try again.');
                        payButton.disabled = false;
                        payButton.textContent = 'Pay Now';
                    } else {
                        alert(data.message || 'An error occurred. Please try again.');
                        payButton.disabled = false;
                        payButton.textContent = 'Pay Now';
                    }
                } else {
                    alert('Payment failed. Please try again.');
                    payButton.disabled = false;
                    payButton.textContent = 'Pay Now';
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
                payButton.disabled = false;
                payButton.textContent = 'Pay Now';
            }

            return false;
        }
    </script>
</body>
</html> 